#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

mktmpdir() {
  dir=$(mktemp -t node-$1-XXXX)
  rm -rf $dir
  mkdir -p $dir
  echo $dir
}
function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

# 
S3_BUCKET="cl-heroku"
CCL_PACKAGE="http://${S3_BUCKET}.s3.amazonaws.com/ccl-1.7.tgz"
CCL_PACKAGE=ftp://ftp.clozure.com/pub/release/1.8/ccl-1.8-linuxx86.tar.gz

# parse and derive params
BUILDPACK_DIR=$(cd $(dirname $0); cd ..; pwd) # absolute path of buildpack
BUILD_DIR=$1
CACHE_DIR=$2

echo "-----> compile params: $BUILD_DIR $CACHE_DIR"

if [ $RESET_CACHE ]; then
  echo "-----> flushing cache"
  rm -rf $CACHE_DIR/*
fi

CCL_DIR="$CACHE_DIR/ccl"
SBCL_DIR="$CACHE_DIR/sbcl"

echo "-----> Installing ccl"
if [ ! -d $CCL_DIR ]; then
    echo "-----> Fetching ccl"    
    curl $CCL_PACKAGE -s -o -  | tar xzf - -C $CACHE_DIR
fi

# add to slug 
cp -r $CCL_DIR $BUILD_DIR

echo "ccl installed" | indent

if [ ! -d $SBCL_DIR ]; then
    echo "-----> Fetching sbcl"    
    SBCL_PACKAGE="http://sbcl-heroku.s3.amazonaws.com/sbcl-1.0.54-x86-64-linux-binary.tar.bz2"
    mkdir $SBCL_DIR && curl $SBCL_PACKAGE -s -o -  | tar xjf - -C $SBCL_DIR
    chmod +x $SBCL_DIR/sbcl-1.0.54-x86-64-linux/run-sbcl.sh
fi
# add to slug 
cp -r $SBCL_DIR $BUILD_DIR
echo "sbcl installed" | indent

cp $BUILDPACK_DIR/bin/buildpack-utils.lisp $BUILD_DIR

# setting up paths for building

export BUILDPACK_DIR
export CACHE_DIR
export BUILD_DIR
export CCL_DEFAULT_DIRECTORY=$CCL_DIR

echo "-----> Starting build"
#XDG_CACHE_HOME="$BUILD_DIR/.asdf/" $CCL_DEFAULT_DIRECTORY/scripts/ccl64 --load "$BUILDPACK_DIR/bin/compile.lisp" --eval "(ccl:quit)"
$CACHE_DIR/sbcl/sbcl-1.0.54-x86-64-linux/run-sbcl.sh --load "$BUILDPACK_DIR/bin/compile.lisp" --eval "(sb-ext:quit)"
echo "-----> Build finished"
